---
title: Понимаем корутины в Lua
date: '2019-08-14 13:37:00'
slug: lua-coroutines
image: https://s3.amd-nick.me/2019/08/lua-coroutines.jpg
tags: [lua]
---

![](https://s3.amd-nick.me/2019/08/lua-coroutines.jpg)

**Coroutines (сопрограммы)** позволяют разбивать громоздкие задачи на части, чтобы те не "вешали" процесс.

<!--truncate-->

## Понимание работы

Допустим, у вас есть тяжелый цикл, который выполняется целую секунду. Мы берем этот цикл, засовываем в корутину и после каждой итерации делаем `.yield`. Теперь один шаг этого цикла будет выполняться за один тик.

**Yield** это что-то вроде промежуточного return. Возвращает любые данные посреди задачи и ставит ее на "паузу" до следующего обращения через `coroutine.resume`. После resume задача продолжится с места yield. Самих yield в задаче может быть несколько и наглядно это видно со [статейки](https://ilovelua.wordpress.com/2012/02/02/%D1%81%D0%BE%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D1%8Bcoroutines/) на моем любимом сайте о Lua и еще лучше [вот тут](https://ru.stackoverflow.com/a/620440).

Корутины не ускоряют работу ваших функций. Они "размазывают" их и выполняют шагами. **Словно это повторяющийся таймер**

## Примеры использования

- Есть 100 игроков и каждому нужно просчитать баланс. Допустим, это тяжелая функция
- У нас скрипт, позволяющий копировать и восстанавливать все объекты на карте. Спавн объекта - затратная функция, объектов может быть 100+
- Обновление большого количества данных на HUD
- Сохранение/чтение данных игроков в БД/файлы
- Разбивка функции загрузки какой-то модели

Догадались, как применить корутины? :)
Применений очень много - их можно ткнуть почти везде, где допустимо "фоновое" выполнение задачи, которая состоит из тяжелых функций.

## Использование корутин

- [Пример с вики для Garry's Mod разработчиков](https://wiki.garrysmod.com/page/coroutine/create) - здесь hook Think что-то вроде `while true do`, который в этой игре намертво вешает сервер. Он срабатывает каждый тик
- [Обертка для этих корутин](https://gist.github.com/a05cd16218df1ac13fce). В конце есть примеры, позволяющие выполнять асинхронные функции последовательно (fetch, playfile ...)

## Для лучшего понимания

[Мой телеграм чатик](https://t.me/+pf3ZgCscKR85ZmIy), с которого взята часть информации на тему корутин, а еще вы тут можете задать свои вопросы. Отсюда пришло понимание и заинтересованность в них. [Вот вырезка самого важного](https://pastebin.com/BfyNLHfj)
